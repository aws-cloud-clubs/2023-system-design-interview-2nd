# 기초 설계안

![image](https://github.com/junchanpp/2023-system-design-interview-2nd/assets/49396352/2ac5fa86-2713-4f16-909e-998bdbcbfad6)


- 각종 서비스에서 알림 서비스를 통해 여러 방법으로 사용자에게 알림을 보낸다.
- 제 3 사업자 제공 서비스는 APNS(애플 디바이스), FCM(안드로이드 디바이스), SMS 서비스(SMS 메시지 전송), 이메일 서비스(SMS 서비스)가 대표적으로 존재한다. 이 서비스를 통해 실질적으로 사용자에게 알림을 전송한다.

이러한 알림을 보내기 전에 반드시 사용자의 단말 정보나, 전화번호, 이메일 주소를 수집해야 한다. 보통 사용자가 앱을 설치하거나 처음으로 계정을 등록하면 api를 통해 해당 정보를 데이터베이스에 저장한다.

![image](https://github.com/junchanpp/2023-system-design-interview-2nd/assets/49396352/c62c8b5c-5030-43e9-af4d-03a8f4c2d2e4)


위의 단순한 구조에서는 SPOF 문제와 알림 서비스가 한 대이기 때문에 확장성이 낮다는 문제와 성능 병목 문제가 있다. 서버가 한 대이기 때문에 해당 서버에 장애가 발생하면 모든 서비스의 장애로 전파가 된다. 또한 한대 서비스로 푸시 알림에 관계된 모든 것을 처리하므로, 데이터베이스나 캐시 등 중요 컴포넌트의 규모를 개별적으로 늘릴 방법이 없다. 또한 제 3 사업자 제공 서비스를 이용할 때 응답을 기다리는 것이 시간이 많이 걸릴 가능성이 있는 작업이다. 따라서 모든 것을 한 서버로 처리하면 사용자 트래픽이 많이 몰리는 시간에는 시스템이 과부하 상태에 빠질 수 있다. 

## 개선된 설계안

![image](https://github.com/junchanpp/2023-system-design-interview-2nd/assets/49396352/a6f93292-6914-4673-a01c-3427fbc25aa3)


- 알림 서버
    
    알림 전송 API, 알림 검증, 데이터베이스 또는 캐시 질의, 알림 전송 등의 역할을 수행한다.
    
- 캐시, 데이터베이스
    
    사용자 정보, 단말 정보, 알림 템플릿, 설정 등 다양한 정보를 저장한다.
    
- 메시지 큐
    
    시스템 컴포넌트 간 의존성을 제거하기 위해 사용한다. 다량의 알림이 전송되어야 하는 경우를 대비한 버퍼 역할도 한다. 본 설계안에서는 알림의 종류별로 별도 메시지 큐를 사용하였다. 따라서 제 3자 서비스 가운데 하나에 장애가 발생해도 다른 종류의 알림은 정상 동작하게 된다.
    
- 작업 서버
    
    메시지 큐에서 전송할 알림을 꺼내서 제 3자 서비스로 전달하는 역할을 담당하는 서버다.
    

## 안정성

데이터 손실 방지와 알림 중복 전송 방지에 대해 고려해야 한다.

### 데이터 손실 방지

알림 시스템은 알림 데이터를 데이터 베이스에 보관하고 재시도 매커니즘을 구현해야 한다.

### 알림 중복 전송 방지

같은 알림이 여러 번 반복되는 것을 완전히 막는 것은 어렵다. 분산 시스템의 특성상 가끔은 같은 알림이 중복되어 전송되기도 할 것이다. 그 빈도를 줄이려면 중복을 탐지하는 매커니즘을 도입하고, 오류를 신중하게 처리해야 한다.

## 그 외

### 푸시 알림과 보안

IOS와 안드로이드 앱의 경우 알림 전송 API는 appKey와 appSecret을 사용하여 보안을 유지한다. 따라서 인증된, 혹은 승인되 클라이언트만 해당 API를 사용하여 알림을 보낼 수 있다.

### 큐 모니터링

알림 시스템을 모니터링할 때 중요한 메트릭 하나는 큐에 쌓은 알림의 개수이다. 이 수가 너무 크면 작업 서버들이 이벤트를 빠르게 처리하지 못하다는 뜻이다. 작업 서버를 증설하는게 바람직할 것이다.

### 이벤트 추적

알림 확인율, 클릭율, 실제 앱 사용으로 이어지는 비율 같은 메트릭은 사용자를 이해하는데 중요하다. 데이터 분석 서비스는 보통 이벤트 추적 기능도 제공한다. 따라서 보통 알림 시스템을 만들면 데이터 분석 서비스와도 통합해야 한다. 

## 수정된 설계안

![image](https://github.com/junchanpp/2023-system-design-interview-2nd/assets/49396352/a4eb705c-eadf-44b5-af4a-f374f617262c)
