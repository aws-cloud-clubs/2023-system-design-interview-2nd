# 11장 뉴스 피드 시스템 설계

뉴스 피드란 페이스북, 인스타그램, 트위터 등의 서비스에서 홈페이지 중앙에 지속적으로 업데이트되는 스토리들로, 사용자 상태 정보 업데이트, 사진, 비디오, 링크, 앱 활동 등을 포함한다. 

## 계략적 설계

### 피드 발행

사용자가 스토리를 포스팅하면 해당 데이터를 캐시와 데이터베이스에 기록한다. 새 포스팅은 친구의 뉴스 피드에도 전송된다.

- 사용자: 모바일 앱이나 브라우저에서 새 포스팅을 올리는 주체
- 로드밸런서: 트래픽을 웹 서버들로 분산
- 웹 서버: HTTP 요청을 내부 서비스로 중계
- 포스팅 저장 서비스: 새 포스팅을 데이터베이스와 캐시에 저장
- 포스팅 전송 서비스: 새 포스팅을 친구의 뉴스 피드에 푸시, 뉴스 피드 테이터는 캐시에 보관
- 알림 서비스: 친구들에게 새 포스팅이 올라왔음을 알리거나, 푸시 알림을 보내는 역할

### 뉴스 피드 생성

지면 관계상 뉴스 피드는 모든 친구의 포스팅을 시간 흐름 역순으로 모아서 만든다고 가정한다.

- 사용자: 뉴스 피드를 읽는 주체
- 로드밸런서: 트레픽을 웹 서버들로 분산
- 웹 서버: 트래픽을 뉴스 피드 서비스로 보냄
- 뉴스 피드 서비스: 캐시에서 뉴스 피드를 가져오는 서비스
- 뉴스 피드 캐시: 뉴스 피드를 렌더링할 때 필요한 ID를 보관

## 상세 설계

### 웹 서버

클라이언트와의 통신뿐만 아니라 인증이나 처리율 제한 등의 기능도 수행함.

스팸을 막고 유해한 콘텐츠가 자주 올라오는 것을 방지하기 위해 특정 기간 동안 한 사용자가 올릴 수 있는 포스팅의 수에 제한을 두어야 함

### 포스팅 전송(팬아웃) 서비스

포스팅 전송(=팬아웃)은 어떤 사용자의 새 포스팅을 그 사용자와 친구 관계에 있는 모든 사용자에게 전달하는 과정이다.

- **푸시 모델: 쓰기 시점에 팬아웃 하는 모델**
    - 새로운 포스팅을 기록하는 시점에 뉴스 피드를 갱신
    - 포스팅이 완료되면 바로 해당 사용자의 캐시에 해당 포스팅을 기록
    - 장점
        - 뉴스 피드가 실시간으로 갱신되며 친구 목록에 있는 사용자에게 즉시 전송됨
        - 새 포스팅이 기록되는 순간에 뉴스 피드가 이미 갱신되므로 뉴스 피드를 읽는 시간이 짧아짐
    - 단점
        - 친구가 많은 사용자의 경우 친구 목록을 가져오고 그 목록에 있는 사용자 모두의 뉴스 피드를 갱신하는 데 많은 시간이 소요될 수 있음 (핫키 문제)
        - 서비스를 자주 이용하지 않는 사용자의 피드까지 갱신해야 하므로 컴퓨팅 자원이 낭비됨
- **풀 모델: 읽기 시점에 팬아웃 하는 모델**
    - 피드를 읽어야 하는 시점에 뉴스 피드를 갱신 (=요청 기반 모델)
    - 사용자가 본인 홈페이지나 타임라인을 로딩하는 시점에 새로운 포스트를 가져옴
    - 장점
        - 비활성화된 사용자, 또는 서비스에 거의 로그인하지 않는 사용자의 경우 이 모델이 유리
        - 데이터를 친구 각각에 푸시하는 작업이 필요 없어지므로 핫키 문제 X
    - 단점
        - 뉴스 피드를 읽는 데 많은 시간이 소요될 수 있다.
- **절충안**
    - 뉴스 피드를 빠르게 가져올 수 있도록 하는 것은 아주 중요하므로 대부분의 사용자에 대해서는 푸시 모델 사용
    - 친구나 팔로워가 아주 많은 사용자의 경우에는 팔로워로 하여금 해당 사용자의 포스팅을 필요할 때 가져가도록 하는 풀 모델을 사용해 시스템 과부하 방지
    - 안정 해시를 통해 요청과 데이터를 보다 고르게 분산하여 핫키 문제를 줄임
